LayoutGuard CLI - Technical Specification

1. Overview

layout-guard is a command-line interface (CLI) tool designed to automate visual regression testing for web applications. It uses Playwright to drive a browser, execute user-defined scenarios, take screenshots, and compare them against previously approved "golden" snapshots stored in a central .layoutguard directory.

The primary goal is to provide developers with a simple, configuration-driven way to catch unintended UI layout changes, preventing visual bugs from reaching production.
2. Core Features

    Scenario-based Testing: Users define test scenarios in simple JavaScript files that can be located anywhere in the project.

    Centralized Snapshot Management: The tool manages all artifacts (snapshots, failures, diffs) in a root .layoutguard directory.

    Interactive Approval Workflow: A simple command allows users to review and approve new or changed snapshots.

    CI/CD Integration: Exits with a non-zero status code if visual differences are detected.

    Flexible Targeting: Users can specify which element to capture in a screenshot.

    Immediate Diff Viewing: An option to automatically open a visual diff image when a test fails.

3. Command-Line Interface (CLI)

The layout-guard tool will expose a few simple commands.
layout-guard check [test-name]

This is the primary command for running tests.

    Description: Executes visual regression tests. It finds and runs test script(s), takes new screenshots, and compares them against the golden snapshots.

    Arguments:

        [test-name] (optional): The name of a specific test to run (e.g., "Dashboard Add Form Popup"). If omitted, layout-guard will run all tests found.

    Options:

        --show-diff: If a test fails, automatically open the visual diff image in the default system viewer.

    Behavior:

        Launches a headless browser using Playwright.

        Executes the steps defined in the test script.

        Takes a screenshot and compares it with the corresponding golden snapshot from the .layoutguard/__snapshots__/ directory.

        If snapshots match, the test passes.

        If snapshots differ, the test fails. The tool will save the new screenshot, the original, and a diff.png image in a corresponding subdirectory within .layoutguard/__failures__/.

        If the --show-diff flag was used, the tool will attempt to open the generated diff.png file.

        Exits with code 0 if all tests pass, 1 if any test fails.

layout-guard approve [test-name]

This command updates the golden snapshots.

    Description: Runs the specified test(s) and replaces the existing golden snapshots with the newly generated ones.

    Arguments:

        [test-name] (optional): The name of a specific test to approve. If omitted, it will update snapshots for all found tests.

    Behavior:

        Executes the test script(s) just like the check command.

        Overwrites the corresponding file in the .layoutguard/__snapshots__/ directory with the new screenshot.

        Cleans up any corresponding failure reports from the .layoutguard/__failures__/ directory.

layout-guard init

This command initializes a new project.

    Description: Sets up the necessary configuration and directory structure for layout-guard.

    Behavior:

        Creates a layout-guard.config.json file in the project root.

        Creates a .layoutguard directory.

        Creates an examples/ directory with an example test file (example.spec.js).

        Prints instructions on how to configure and run the tool, including Playwright browser installation.

4. Test Script Specification

Test scenarios are defined in .spec.js files. Each file exports a default object that conforms to the LayoutTest interface.

Snapshot Naming: The snapshot image file (e.g., my-cool-test.png) is generated by slugifying the name property of the test.

Interface Definition (LayoutTest):

import { Page } from 'playwright';

interface LayoutTest {
  /** A unique, descriptive name for the test. This is used for the snapshot filename. */
  name: string;

  /** The sequence of actions to perform before taking the screenshot. */
  scenario: (page: Page) => Promise<void>;

  /** Optional. A CSS selector for the element to capture. If omitted, the full page is captured. */
  selector?: string;
}

Example Test Script (examples/example.spec.js):

const test = {
  name: 'Dashboard Add Form Popup',

  scenario: async (page) => {
    await page.goto('/dashboard');
    await page.click('#add-new-item-button');
    await page.waitForSelector('.add-item-popup', { state: 'visible' });
    await page.waitForTimeout(500); // Wait for CSS transitions
  },

  selector: '.add-item-popup',
};

module.exports = test;

5. Directory Structure

All test-related artifacts are stored in a single .layoutguard directory in the project root. Test files can be located anywhere.

my-awesome-project/
├── .layoutguard/
│   ├── snapshots/
│   │   ├── dashboard-add-form-popup.png  // Golden snapshot
│   │   └── another-test.png
│   └── failures/
│       └── dashboard-add-form-popup/
│           ├── new.png       // The latest screenshot
│           ├── original.png  // The golden snapshot it was compared against
│           └── diff.png      // A visual diff of the two
├── examples/
│   └── example.spec.js  // Example test file
├── node_modules/
├── layout-guard.config.json
├── package.json
└── README.md

6. Configuration (layout-guard.config.json)

The configuration file allows users to customize behavior.

```json
{
  "testMatch": ["examples/**/*.spec.js"],
  "baseUrl": "http://localhost:3000",
  "playwright": {
    "browserName": "chromium"
  },
  "diffThreshold": 0.01
}
```

Interface Definition (Config):

```javascript
{
  /** A glob pattern to find test files. */
  testMatch: string[];

  /** The base URL to prepend to navigation actions (e.g., page.goto('/dashboard')). */
  baseUrl: string;

  /** Playwright options, e.g., which browser to use. */
  playwright?: {
    browserName: 'chromium' | 'firefox' | 'webkit';
  };

  /** Threshold for pixel difference (0 to 1). 0 means zero tolerance. */
  diffThreshold?: number;
}
```

7. Technical Stack

    Language: TypeScript (for the CLI tool), JavaScript (for test files)

    CLI Framework: commander.js

    Browser Automation: playwright

    Image Comparison: pixelmatch

    File Opening: open (or similar cross-platform library)

    Packaging: npm